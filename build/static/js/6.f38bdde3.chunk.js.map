{"version":3,"sources":["hooks/useOnCall.js","pages/CallPage.jsx"],"names":["useOnCall","history","useHistory","callDocId","useSelector","state","call","activeCall","isReceivingCall","localVideoRef","useRef","remoteVideoRef","useState","isRemoteStreamAvailable","setIsRemoteStreamAvailable","stream","setStream","isRemoteStreamVideoEnabled","setIsRemoteStreamVideoEnabled","peerRef","Peer","isAudioEnabled","setIsAudioEnabled","isVideoEnabled","setIsVideoEnabled","getLocalStream","a","navigator","mediaDevices","getUserMedia","video","audio","current","srcObject","console","log","useEffect","length","push","toast","error","getTracks","forEach","track","stop","initiator","trickle","on","data","firestore","collection","doc","add","onSnapshot","snapshot","docChanges","change","type","destroyed","signal","success","string","TextDecoder","decode","object","JSON","parse","message","undefined","loading","t","style","display","alignItems","Button","color","onClick","dismiss","id","position","icon","duration","addListener","_pc","oniceconnectionstatechange","iceConnectionState","removeAllListeners","destroy","toggleAudio","getAudioTracks","enabled","toggleVideo","getVideoTracks","send","stringify","sendMessage","useStyles","makeStyles","theme","root","flex","flexDirection","marginTop","width","justifyContent","breakpoints","down","gap","callContainer","height","streams","overflow","maxWidth","objectFit","userInfo","bottom","left","background","padding","mutedVideoUserInfo","mutedVideoAvatar","controlls","buttonIcon","hiddenVideo","strikeThrough","clipPath","palette","secondary","main","top","textField","right","CallPage","classes","userData","user","otherPhotoURL","otherDisplayName","otherUserData","setOtherUserData","photoURL","displayName","otherUserId","from","userOnOtherSide","get","then","className","Paper","elevation","ref","autoPlay","playsInline","Avatar","src","alt","Typography","variant","transform","muted","borderRadius","minWidth","disableElevation","TextField","label","onKeyDown","e","key","target","value","trim"],"mappings":"wWAkPeA,EA1OG,WAChB,IAAMC,EAAUC,cACVC,EAAYC,uBAAY,SAACC,GAAD,uBAAWA,EAAMC,KAAKC,kBAAtB,aAAW,EAAuBJ,aAC1DK,EAAkBJ,uBAAY,SAACC,GAAD,OAAWA,EAAMC,KAAKE,mBAEpDC,EAAgBC,mBAChBC,EAAiBD,mBAEvB,EAA8DE,oBAAS,GAAvE,mBAAOC,EAAP,KAAgCC,EAAhC,KAEA,EAA4BF,qBAA5B,mBAAOG,EAAP,KAAeC,EAAf,KAEA,EACEJ,oBAAS,GADX,mBAAOK,EAAP,KAAmCC,EAAnC,KAGMC,EAAUT,iBAAO,IAAIU,KAE3B,EAA4CR,oBAAS,GAArD,mBAAOS,EAAP,KAAuBC,EAAvB,KACA,EAA4CV,oBAAS,GAArD,mBAAOW,EAAP,KAAuBC,EAAvB,KA2BMC,EAAc,uCAAG,4BAAAC,EAAA,+EAEEC,UAAUC,aAAaC,aAAa,CACvDC,OAAO,EACPC,OAAO,IAJU,OAEbhB,EAFa,OAMnBC,EAAUD,GACVN,EAAcuB,QAAQC,UAAYlB,EAPf,gDASnBmB,QAAQC,IAAR,MATmB,yDAAH,qDA8KpB,OAjKAC,qBAAU,WAYR,OATKrB,GAAUZ,GACbsB,KAGE,OAACtB,QAAD,IAACA,OAAD,EAACA,EAAWkC,UACdpC,EAAQqC,KAAK,cACbC,IAAMC,MAAM,kBAGP,WACC,OAANzB,QAAM,IAANA,KAAQ0B,YAAYC,SAAQ,SAACC,GAC3BA,EAAMC,aAGT,CAAC7B,EAAQZ,EAAWF,IAEvBmC,qBAAU,WAyHR,OAxHIjC,GAAaY,IACXP,GACFW,EAAQa,QAAU,IAAIZ,IAAK,CACzByB,WAAW,EACXC,SAAS,EACT/B,OAAQA,IAGVI,EAAQa,QAAQe,GAAG,UAAU,SAACC,GAC5BC,IACGC,WAAW,SACXC,IAAIhD,GACJ+C,WAAW,YACXE,IAAIJ,MAETC,IACGC,WAAW,SACXC,IAAIhD,GACJ+C,WAAW,UACXG,YAAW,SAACC,GACXA,EAASC,aAAab,SAAQ,SAACc,GAC7B,GAAoB,UAAhBA,EAAOC,OAAqBtC,EAAQa,QAAQ0B,UAAW,CACzD,IAAMV,EAAOQ,EAAOL,IAAIH,OAExB7B,EAAQa,QAAQ2B,OAAOX,UAK/B7B,EAAQa,QAAQe,GAAG,UAAU,SAAChC,GAC5BmB,QAAQC,IAAI,mBACZrB,GAA2B,GAC3ByB,IAAMqB,QAAQ,0BACdjD,EAAeqB,QAAQC,UAAYlB,OAGrCI,EAAQa,QAAU,IAAIZ,IAAK,CACzByB,WAAW,EACXC,SAAS,EACT/B,OAAQA,IAGVI,EAAQa,QAAQe,GAAG,UAAU,SAACC,GAC5BC,IACGC,WAAW,SACXC,IAAIhD,GACJ+C,WAAW,UACXE,IAAIJ,MAETC,IACGC,WAAW,SACXC,IAAIhD,GACJ+C,WAAW,YACXG,YAAW,SAACC,GACXA,EAASC,aAAab,SAAQ,SAACc,GAC7B,GAAoB,UAAhBA,EAAOC,OAAqBtC,EAAQa,QAAQ0B,UAAW,CACzD,IAAMV,EAAOQ,EAAOL,IAAIH,OAExB7B,EAAQa,QAAQ2B,OAAOX,UAK/B7B,EAAQa,QAAQe,GAAG,UAAU,SAAChC,GAC5BmB,QAAQC,IAAI,mBACZrB,GAA2B,GAE3BH,EAAeqB,QAAQC,UAAYlB,MAGvCI,EAAQa,QAAQe,GAAG,QAAQ,SAACC,GAC1B,IAAMa,GAAS,IAAIC,aAAcC,OAAOf,GAClCgB,EAASC,KAAKC,MAAML,GAC1B,EAA4DG,EAApDG,eAAR,WAAkBC,EAAlB,IAA4DJ,EAA/BzC,sBAA7B,WAA8C6C,EAA9C,OAEuBA,IAAnB7C,GACFL,EAA8BK,GAG5B4C,GACF5B,IAAM8B,SACJ,SAACC,GAAD,OACE,sBAAKC,MAAO,CAAEC,QAAS,OAAQC,WAAY,UAA3C,UACE,4BAAIN,IACJ,cAACO,EAAA,EAAD,CACEH,MAAO,CAAEC,QAAS,gBAClBG,MAAM,YACNC,QAAS,kBAAMrC,IAAMsC,QAAQP,EAAEQ,KAHjC,yBASJ,CACEC,SAAU,YACVC,KAAM,eACNC,SAAU,SAKlB9D,EAAQa,QAAQe,GAAG,SAAS,WAC1BR,IAAMC,MAAM,sCACZvC,EAAQqC,KAAK,iBAEfnB,EAAQa,QAAQe,GAAG,SAAS,WAC1BR,IAAMC,MAAM,gBACZvC,EAAQqC,KAAK,iBAEfnB,EAAQa,QAAQkD,YAAY,OAAO,WACjC3C,IAAMC,MAAM,gBACZvC,EAAQqC,KAAK,iBAEfnB,EAAQa,QAAQmD,IAAIC,2BAA6B,WACA,iBAA3CjE,EAAQa,QAAQmD,IAAIE,oBACtBpF,EAAQqC,KAAK,gBAKZ,WAAO,IAAD,IACX,UAAAnB,EAAQa,eAAR,SAAiBsD,qBACjB,UAAAnE,EAAQa,eAAR,SAAiBuD,UACjBpE,EAAQa,QAAU,QAEnB,CAAC7B,EAAWK,EAAiBO,EAAQd,IAExCmC,qBAAU,WACR,IAAI0C,EAQJ,OAPKjE,GAGH0B,IAAMsC,QAAQC,GACdvC,IAAMqB,QAAQ,2BAHdkB,EAAKvC,IAAM8B,QAAQ,iBAMd,WACDS,GAAIvC,IAAMsC,QAAQC,MAEvB,CAACjE,IAEG,CACLJ,gBACAE,iBACAE,0BACAM,UACAX,kBACAgF,YA7MkB,WACdzE,IACFA,EAAO0E,iBAAiB,GAAGC,SAAW3E,EAAO0E,iBAAiB,GAAGC,QACjEpE,EAAkBP,EAAO0E,iBAAiB,GAAGC,WA2M/CC,YAvMkB,WACd5E,IACFA,EAAO6E,iBAAiB,GAAGF,SAAW3E,EAAO6E,iBAAiB,GAAGF,QACjElE,EAAkBT,EAAO6E,iBAAiB,GAAGF,SAC7CvE,EAAQa,QAAQ6D,KACd5B,KAAK6B,UAAU,CACbvE,eAAgBR,EAAO6E,iBAAiB,GAAGF,aAkMjDrE,iBACAE,iBACAN,6BACA8E,YA/LkB,SAAC5B,GACfhD,EAAQa,UAAYb,EAAQa,QAAQ0B,WACtCvC,EAAQa,QAAQ6D,KAAK5B,KAAK6B,UAAU,CAAE3B,gBChCtC6B,EAAYC,aAAW,SAACC,GAAD,MAAY,CACvCC,KAAK,aACHC,KAAM,EACN5B,QAAS,OACT6B,cAAe,SACftB,SAAU,WACVuB,UAAW,OACXC,MAAO,OACPC,eAAgB,SAChB/B,WAAY,UACXyB,EAAMO,YAAYC,KAAK,MAAQ,CAC9BJ,UAAW,OACXK,IAAK,SAGTC,cAAc,aACZL,MAAO,MACPM,OAAQ,QACPX,EAAMO,YAAYC,KAAK,MAAQ,CAC9BH,MAAO,OACPM,OAAQ,OACRrC,QAAS,OACT6B,cAAe,SACfG,eAAgB,WAGpBM,QAAQ,aACNtC,QAAS,OACTmC,IAAK,OACLE,OAAQ,MACRL,eAAgB,UACfN,EAAMO,YAAYC,KAAK,MAAQ,CAC9BL,cAAe,SACfE,MAAO,OACPI,IAAK,WAGT5F,OAAQ,CACNgE,SAAU,WACV8B,OAAQ,OACRT,KAAM,EACNW,SAAU,SACVC,SAAU,QACV,YAAa,CACXH,OAAQ,OACRN,MAAO,OACPU,UAAW,UAGfC,SAAU,CACRnC,SAAU,WACVoC,OAAQ,EACRC,KAAM,EACNb,MAAO,OACPc,WACE,yEACFC,QAAS,OACT9C,QAAS,OACTmC,IAAK,OACLlC,WAAY,UAEd8C,mBAAoB,CAClBxC,SAAU,WACVoC,OAAQ,EACRC,KAAM,EACNb,MAAO,OACPM,OAAQ,OACRrC,QAAS,OACT6B,cAAe,SACfG,eAAgB,SAChB/B,WAAY,SACZkC,IAAK,QAEPa,iBAAkB,CAChBX,OAAQ,IACRN,MAAO,KAETkB,UAAW,CACTlB,MAAO,OACP/B,QAAS,OACTgC,eAAgB,SAChBF,UAAW,OACXK,IAAK,QAEPe,WAAY,CACVnB,MAAO,OACPM,OAAQ,QAEVc,YAAa,CACXnD,QAAS,QAEXoD,cAAe,CACbC,SAAU,0CACVR,WAAYnB,EAAM4B,QAAQC,UAAUC,KACpCzB,MAAO,OACPM,OAAQ,OACR9B,SAAU,WACVkD,IAAK,EACLb,KAAM,GAERc,UAAU,aACR3B,MAAO,OACPS,SAAU,QACVjC,SAAU,WACVoC,OAAQ,OACRgB,MAAO,KAENjC,EAAMO,YAAYC,KAAK,MAAQ,CAC9B3B,SAAU,WACVoC,OAAQ,IACRgB,MAAO,IACP5B,MAAO,OACPS,SAAU,aAuLDoB,UAlLE,WACf,IAAMC,EAAUrC,IACVsC,EAAWlI,uBAAY,SAACC,GAAD,oBAAWA,QAAX,IAAWA,GAAX,UAAWA,EAAOkI,YAAlB,aAAW,EAAaD,YACrD,EAA0C1H,mBAAS,CACjD4H,cAAe,GACfC,iBAAkB,KAFpB,mBAAOC,EAAP,KAAsBC,EAAtB,KAKA,EAAkCL,GAAY,CAC5CM,SAAU,GACVC,YAAa,IAFPD,EAAR,EAAQA,SAAUC,EAAlB,EAAkBA,YAKlB,EAA4CH,GAAiB,CAC3DF,cAAe,GACfC,iBAAkB,IAFZD,EAAR,EAAQA,cAAeC,EAAvB,EAAuBA,iBAIvB,EAYIzI,IAXFS,EADF,EACEA,cACAE,EAFF,EAEEA,eACAE,EAHF,EAGEA,wBACAM,EAJF,EAIEA,QACAX,EALF,EAKEA,gBACAgF,EANF,EAMEA,YACAG,EAPF,EAOEA,YACAtE,EARF,EAQEA,eACAE,EATF,EASEA,eACAN,EAVF,EAUEA,2BACA8E,EAXF,EAWEA,YAGIxF,EAAaH,uBAAY,SAACC,GAAD,OAAWA,EAAMC,KAAKC,cAoBrD,OAlBA6B,qBAAU,WACR,GAAI7B,EAAY,CACd,IAAMuI,EAActI,EAChBD,EAAWwI,KACXxI,EAAWyI,gBAEf/F,IACGC,WAAW,SACXC,IAAI2F,GACJG,MACAC,MAAK,SAAC/F,GACL,MACEA,EAAIH,OADYwF,EAAlB,EAAQI,SAAsCH,EAA9C,EAAiCI,YAEjCF,EAAiB,CAAEH,gBAAeC,2BAGvC,CAAClI,EAAYC,IAGd,sBAAK2I,UAAWd,EAAQlC,KAAxB,UACE,sBAAKgD,UAAWd,EAAQzB,cAAxB,UACE,sBAAKuC,UAAWd,EAAQvB,QAAxB,UACE,eAACsC,EAAA,EAAD,CACEC,UAAW,EACXF,UAAS,UACPtI,EAA0BwH,EAAQtH,OAASsH,EAAQV,aAHvD,UAME,uBAAO2B,IAAK3I,EAAgB4I,UAAQ,EAACC,aAAW,IAChD,sBACEL,UACElI,EACIoH,EAAQnB,SACRmB,EAAQd,mBAJhB,UAOE,cAACkC,EAAA,EAAD,CACEC,IAAKlB,EACLmB,IAAI,eACJR,UACElI,EAA6B,GAAKoH,EAAQb,mBAG9C,cAACoC,EAAA,EAAD,CAAYC,QAAQ,KAApB,SAA0BpB,UAI9B,eAACW,EAAA,EAAD,CAAOC,UAAW,EAAGF,UAAWd,EAAQtH,OAAxC,UAEE,uBACEwD,MAAO,CAAEuF,UAAW,cACpBR,IAAK7I,EACLsJ,OAAK,EACLR,UAAQ,EACRC,aAAW,IAEb,sBACEL,UACE5H,EAAiB8G,EAAQnB,SAAWmB,EAAQd,mBAFhD,UAKE,cAACkC,EAAA,EAAD,CACEC,IAAKd,EACLe,IAAI,eACJR,UAAW5H,EAAiB,GAAK8G,EAAQb,mBAE3C,cAACoC,EAAA,EAAD,CAAYC,QAAQ,KAApB,SAA0BhB,aAIhC,sBAAKM,UAAWd,EAAQZ,UAAxB,UACE,eAAC/C,EAAA,EAAD,CACEH,MAAO,CACLyF,aAAc,MACdzD,MAAO,OACPM,OAAQ,OACRoD,SAAU,MACVlF,SAAU,WACVgC,SAAU,UAEZ8C,QAAQ,WACRlF,MAAOtD,EAAiB,UAAY,YACpCuD,QAASY,EACT0E,kBAAmB7I,EAZrB,UAcE,cAAC,IAAD,CAAS8H,UAAWd,EAAQX,aAC5B,qBAAKyB,UAAW9H,EAAiB,GAAKgH,EAAQT,mBAEhD,eAAClD,EAAA,EAAD,CACEH,MAAO,CACLyF,aAAc,MACdzD,MAAO,OACPM,OAAQ,OACRoD,SAAU,MACVlF,SAAU,WACVgC,SAAU,UAEZ8C,QAAQ,WACRlF,MAAOpD,EAAiB,UAAY,YACpCqD,QAASe,EACTuE,kBAAmB3I,EAZrB,UAcE,cAAC,IAAD,CAAc4H,UAAWd,EAAQX,aACjC,qBAAKyB,UAAW5H,EAAiB,GAAK8G,EAAQT,mBAEhD,cAAClD,EAAA,EAAD,CACEH,MAAO,CACLyF,aAAc,MACdzD,MAAO,OACPM,OAAQ,OACRoD,SAAU,OAEZJ,QAAQ,WACRlF,MAAM,YACNC,QAAS,WACPzD,EAAQa,QAAQuD,WAVpB,SAaE,cAAC,IAAD,CAAa4D,UAAWd,EAAQX,qBAKtC,cAACyC,EAAA,EAAD,CACEhB,UAAWd,EAAQH,UACnBkC,MAAM,iBACNP,QAAQ,WACRQ,UAAW,SAACC,GACV,GAAc,UAAVA,EAAEC,IAAiB,CAErB,GAA8B,KAA1BD,EAAEE,OAAOC,MAAMC,OAAe,OAClC,GAAIJ,EAAEE,OAAOC,MAAMC,OAAOrI,OAAS,GAGjC,OAFAE,IAAMC,MAAM,4BACZ8H,EAAEE,OAAOC,MAAQ,IAGnB1E,EAAYuE,EAAEE,OAAOC,OACrBH,EAAEE,OAAOC,MAAQ","file":"static/js/6.f38bdde3.chunk.js","sourcesContent":["import { useEffect, useRef, useState } from \"react\";\nimport { useSelector } from \"react-redux\";\nimport { firestore } from \"../lib/firebase/firebase\";\nimport Peer from \"simple-peer\";\nimport toast from \"react-hot-toast\";\nimport { useHistory } from \"react-router\";\nimport { Button } from \"@material-ui/core\";\n\nconst useOnCall = () => {\n  const history = useHistory();\n  const callDocId = useSelector((state) => state.call.activeCall?.callDocId);\n  const isReceivingCall = useSelector((state) => state.call.isReceivingCall);\n\n  const localVideoRef = useRef();\n  const remoteVideoRef = useRef();\n\n  const [isRemoteStreamAvailable, setIsRemoteStreamAvailable] = useState(false);\n\n  const [stream, setStream] = useState();\n\n  const [isRemoteStreamVideoEnabled, setIsRemoteStreamVideoEnabled] =\n    useState(true);\n\n  const peerRef = useRef(new Peer());\n\n  const [isAudioEnabled, setIsAudioEnabled] = useState(true);\n  const [isVideoEnabled, setIsVideoEnabled] = useState(true);\n\n  const toggleAudio = () => {\n    if (stream) {\n      stream.getAudioTracks()[0].enabled = !stream.getAudioTracks()[0].enabled;\n      setIsAudioEnabled(stream.getAudioTracks()[0].enabled);\n    }\n  };\n\n  const toggleVideo = () => {\n    if (stream) {\n      stream.getVideoTracks()[0].enabled = !stream.getVideoTracks()[0].enabled;\n      setIsVideoEnabled(stream.getVideoTracks()[0].enabled);\n      peerRef.current.send(\n        JSON.stringify({\n          isVideoEnabled: stream.getVideoTracks()[0].enabled,\n        })\n      );\n    }\n  };\n\n  const sendMessage = (message) => {\n    if (peerRef.current && !peerRef.current.destroyed) {\n      peerRef.current.send(JSON.stringify({ message }));\n    }\n  };\n\n  const getLocalStream = async () => {\n    try {\n      const stream = await navigator.mediaDevices.getUserMedia({\n        video: true,\n        audio: true,\n      });\n      setStream(stream);\n      localVideoRef.current.srcObject = stream;\n    } catch (error) {\n      console.log(error);\n    }\n  };\n\n  useEffect(() => {\n    // get local video stream\n\n    if (!stream && callDocId) {\n      getLocalStream();\n    }\n\n    if (!callDocId?.length) {\n      history.push(\"/dashboard\");\n      toast.error(\"No call found\");\n    }\n\n    return () => {\n      stream?.getTracks().forEach((track) => {\n        track.stop();\n      });\n    };\n  }, [stream, callDocId, history]);\n\n  useEffect(() => {\n    if (callDocId && stream) {\n      if (isReceivingCall) {\n        peerRef.current = new Peer({\n          initiator: false,\n          trickle: false,\n          stream: stream,\n        });\n\n        peerRef.current.on(\"signal\", (data) => {\n          firestore\n            .collection(\"calls\")\n            .doc(callDocId)\n            .collection(\"receiver\")\n            .add(data);\n        });\n        firestore\n          .collection(\"calls\")\n          .doc(callDocId)\n          .collection(\"sender\")\n          .onSnapshot((snapshot) => {\n            snapshot.docChanges().forEach((change) => {\n              if (change.type === \"added\" && !peerRef.current.destroyed) {\n                const data = change.doc.data();\n\n                peerRef.current.signal(data);\n              }\n            });\n          });\n\n        peerRef.current.on(\"stream\", (stream) => {\n          console.log(\"Stream Received\");\n          setIsRemoteStreamAvailable(true);\n          toast.success(\"Connected Successfully\");\n          remoteVideoRef.current.srcObject = stream;\n        });\n      } else {\n        peerRef.current = new Peer({\n          initiator: true,\n          trickle: false,\n          stream: stream,\n        });\n\n        peerRef.current.on(\"signal\", (data) => {\n          firestore\n            .collection(\"calls\")\n            .doc(callDocId)\n            .collection(\"sender\")\n            .add(data);\n        });\n        firestore\n          .collection(\"calls\")\n          .doc(callDocId)\n          .collection(\"receiver\")\n          .onSnapshot((snapshot) => {\n            snapshot.docChanges().forEach((change) => {\n              if (change.type === \"added\" && !peerRef.current.destroyed) {\n                const data = change.doc.data();\n\n                peerRef.current.signal(data);\n              }\n            });\n          });\n\n        peerRef.current.on(\"stream\", (stream) => {\n          console.log(\"Stream Received\");\n          setIsRemoteStreamAvailable(true);\n\n          remoteVideoRef.current.srcObject = stream;\n        });\n      }\n      peerRef.current.on(\"data\", (data) => {\n        const string = new TextDecoder().decode(data);\n        const object = JSON.parse(string);\n        const { message = undefined, isVideoEnabled = undefined } = object;\n\n        if (isVideoEnabled !== undefined) {\n          setIsRemoteStreamVideoEnabled(isVideoEnabled);\n        }\n\n        if (message) {\n          toast.loading(\n            (t) => (\n              <div style={{ display: \"flex\", alignItems: \"center\" }}>\n                <p>{message}</p>\n                <Button\n                  style={{ display: \"inline-block\" }}\n                  color=\"secondary\"\n                  onClick={() => toast.dismiss(t.id)}\n                >\n                  ❌\n                </Button>\n              </div>\n            ),\n            {\n              position: \"top-right\",\n              icon: \"📩\",\n              duration: 5000,\n            }\n          );\n        }\n      });\n      peerRef.current.on(\"error\", () => {\n        toast.error(\"Something bad happened, retry call\");\n        history.push(\"/dashboard\");\n      });\n      peerRef.current.on(\"close\", () => {\n        toast.error(\"Disconnected\");\n        history.push(\"/dashboard\");\n      });\n      peerRef.current.addListener(\"end\", () => {\n        toast.error(\"Disconnected\");\n        history.push(\"/dashboard\");\n      });\n      peerRef.current._pc.oniceconnectionstatechange = function () {\n        if (peerRef.current._pc.iceConnectionState === \"disconnected\") {\n          history.push(\"/dashboard\");\n        }\n      };\n    }\n\n    return () => {\n      peerRef.current?.removeAllListeners();\n      peerRef.current?.destroy();\n      peerRef.current = null;\n    };\n  }, [callDocId, isReceivingCall, stream, history]);\n\n  useEffect(() => {\n    let id;\n    if (!isRemoteStreamAvailable) {\n      id = toast.loading(\"Connecting...\");\n    } else {\n      toast.dismiss(id);\n      toast.success(\"Connected Successfully\");\n    }\n\n    return () => {\n      if (id) toast.dismiss(id);\n    };\n  }, [isRemoteStreamAvailable]);\n\n  return {\n    localVideoRef,\n    remoteVideoRef,\n    isRemoteStreamAvailable,\n    peerRef,\n    isReceivingCall,\n    toggleAudio,\n    toggleVideo,\n    isAudioEnabled,\n    isVideoEnabled,\n    isRemoteStreamVideoEnabled,\n    sendMessage,\n  };\n};\n\nexport default useOnCall;\n","import {\n  Avatar,\n  Button,\n  makeStyles,\n  Paper,\n  Typography,\n  TextField,\n} from \"@material-ui/core\";\nimport MicIcon from \"@material-ui/icons/Mic\";\nimport CallEndIcon from \"@material-ui/icons/CallEnd\";\nimport VideocamIcon from \"@material-ui/icons/Videocam\";\nimport useOnCall from \"../hooks/useOnCall\";\nimport { useSelector } from \"react-redux\";\nimport { useEffect, useState } from \"react\";\nimport { firestore } from \"../lib/firebase/firebase\";\nimport toast from \"react-hot-toast\";\n\nconst useStyles = makeStyles((theme) => ({\n  root: {\n    flex: 1,\n    display: \"flex\",\n    flexDirection: \"column\",\n    position: \"relative\",\n    marginTop: \"7rem\",\n    width: \"100%\",\n    justifyContent: \"center\",\n    alignItems: \"center\",\n    [theme.breakpoints.down(\"sm\")]: {\n      marginTop: \"10vh\",\n      gap: \"1rem\",\n    },\n  },\n  callContainer: {\n    width: \"80%\",\n    height: \"70vh\",\n    [theme.breakpoints.down(\"sm\")]: {\n      width: \"100%\",\n      height: \"75vh\",\n      display: \"flex\",\n      flexDirection: \"column\",\n      justifyContent: \"center\",\n    },\n  },\n  streams: {\n    display: \"flex\",\n    gap: \"2rem\",\n    height: \"80%\",\n    justifyContent: \"center\",\n    [theme.breakpoints.down(\"sm\")]: {\n      flexDirection: \"column\",\n      width: \"100%\",\n      gap: \"0.5rem\",\n    },\n  },\n  stream: {\n    position: \"relative\",\n    height: \"100%\",\n    flex: 1,\n    overflow: \"hidden\",\n    maxWidth: \"700px\",\n    \"& > video\": {\n      height: \"100%\",\n      width: \"100%\",\n      objectFit: \"cover\",\n    },\n  },\n  userInfo: {\n    position: \"absolute\",\n    bottom: 0,\n    left: 0,\n    width: \"100%\",\n    background:\n      \"linear-gradient(180deg, rgba(0, 0, 0, 0) 0%, rgba(0, 0, 0, 0.98) 100%)\",\n    padding: \"1rem\",\n    display: \"flex\",\n    gap: \"1rem\",\n    alignItems: \"center\",\n  },\n  mutedVideoUserInfo: {\n    position: \"absolute\",\n    bottom: 0,\n    left: 0,\n    width: \"100%\",\n    height: \"100%\",\n    display: \"flex\",\n    flexDirection: \"column\",\n    justifyContent: \"center\",\n    alignItems: \"center\",\n    gap: \"1rem\",\n  },\n  mutedVideoAvatar: {\n    height: 100,\n    width: 100,\n  },\n  controlls: {\n    width: \"100%\",\n    display: \"flex\",\n    justifyContent: \"center\",\n    marginTop: \"2rem\",\n    gap: \"1rem\",\n  },\n  buttonIcon: {\n    width: \"2rem\",\n    height: \"2rem\",\n  },\n  hiddenVideo: {\n    display: \"none\",\n  },\n  strikeThrough: {\n    clipPath: \"polygon(95% 0, 100% 5%, 5% 100%, 0 95%)\",\n    background: theme.palette.secondary.main,\n    width: \"100%\",\n    height: \"100%\",\n    position: \"absolute\",\n    top: 0,\n    left: 0,\n  },\n  textField: {\n    width: \"100%\",\n    maxWidth: \"400px\",\n    position: \"absolute\",\n    bottom: \"10px\",\n    right: \"0\",\n\n    [theme.breakpoints.down(\"sm\")]: {\n      position: \"relative\",\n      bottom: \"0\",\n      right: \"0\",\n      width: \"100%\",\n      maxWidth: \"100%\",\n    },\n  },\n}));\n\nconst CallPage = () => {\n  const classes = useStyles();\n  const userData = useSelector((state) => state?.user?.userData);\n  const [otherUserData, setOtherUserData] = useState({\n    otherPhotoURL: \"\",\n    otherDisplayName: \"\",\n  });\n\n  const { photoURL, displayName } = userData || {\n    photoURL: \"\",\n    displayName: \"\",\n  };\n\n  const { otherPhotoURL, otherDisplayName } = otherUserData || {\n    otherPhotoURL: \"\",\n    otherDisplayName: \"\",\n  };\n  const {\n    localVideoRef,\n    remoteVideoRef,\n    isRemoteStreamAvailable,\n    peerRef,\n    isReceivingCall,\n    toggleAudio,\n    toggleVideo,\n    isAudioEnabled,\n    isVideoEnabled,\n    isRemoteStreamVideoEnabled,\n    sendMessage,\n  } = useOnCall();\n\n  const activeCall = useSelector((state) => state.call.activeCall);\n\n  useEffect(() => {\n    if (activeCall) {\n      const otherUserId = isReceivingCall\n        ? activeCall.from\n        : activeCall.userOnOtherSide;\n\n      firestore\n        .collection(\"users\")\n        .doc(otherUserId)\n        .get()\n        .then((doc) => {\n          const { photoURL: otherPhotoURL, displayName: otherDisplayName } =\n            doc.data();\n          setOtherUserData({ otherPhotoURL, otherDisplayName });\n        });\n    }\n  }, [activeCall, isReceivingCall]);\n\n  return (\n    <div className={classes.root}>\n      <div className={classes.callContainer}>\n        <div className={classes.streams}>\n          <Paper\n            elevation={5}\n            className={`${\n              isRemoteStreamAvailable ? classes.stream : classes.hiddenVideo\n            }`}\n          >\n            <video ref={remoteVideoRef} autoPlay playsInline></video>\n            <div\n              className={\n                isRemoteStreamVideoEnabled\n                  ? classes.userInfo\n                  : classes.mutedVideoUserInfo\n              }\n            >\n              <Avatar\n                src={otherPhotoURL}\n                alt=\"profilePhoto\"\n                className={\n                  isRemoteStreamVideoEnabled ? \"\" : classes.mutedVideoAvatar\n                }\n              />\n              <Typography variant=\"h6\">{otherDisplayName}</Typography>\n            </div>\n          </Paper>\n\n          <Paper elevation={5} className={classes.stream}>\n            {/* must mute own video to avoid feedback */}\n            <video\n              style={{ transform: \"scaleX(-1)\" }}\n              ref={localVideoRef}\n              muted\n              autoPlay\n              playsInline\n            ></video>\n            <div\n              className={\n                isVideoEnabled ? classes.userInfo : classes.mutedVideoUserInfo\n              }\n            >\n              <Avatar\n                src={photoURL}\n                alt=\"profilePhoto\"\n                className={isVideoEnabled ? \"\" : classes.mutedVideoAvatar}\n              />\n              <Typography variant=\"h6\">{displayName}</Typography>\n            </div>\n          </Paper>\n        </div>\n        <div className={classes.controlls}>\n          <Button\n            style={{\n              borderRadius: \"50%\",\n              width: \"4rem\",\n              height: \"4rem\",\n              minWidth: \"0px\",\n              position: \"relative\",\n              overflow: \"hidden\",\n            }}\n            variant=\"outlined\"\n            color={isAudioEnabled ? \"primary\" : \"secondary\"}\n            onClick={toggleAudio}\n            disableElevation={!isAudioEnabled}\n          >\n            <MicIcon className={classes.buttonIcon} />\n            <div className={isAudioEnabled ? \"\" : classes.strikeThrough}></div>\n          </Button>\n          <Button\n            style={{\n              borderRadius: \"50%\",\n              width: \"4rem\",\n              height: \"4rem\",\n              minWidth: \"0px\",\n              position: \"relative\",\n              overflow: \"hidden\",\n            }}\n            variant=\"outlined\"\n            color={isVideoEnabled ? \"primary\" : \"secondary\"}\n            onClick={toggleVideo}\n            disableElevation={!isVideoEnabled}\n          >\n            <VideocamIcon className={classes.buttonIcon} />\n            <div className={isVideoEnabled ? \"\" : classes.strikeThrough}></div>\n          </Button>\n          <Button\n            style={{\n              borderRadius: \"50%\",\n              width: \"4rem\",\n              height: \"4rem\",\n              minWidth: \"0px\",\n            }}\n            variant=\"outlined\"\n            color=\"secondary\"\n            onClick={() => {\n              peerRef.current.destroy();\n            }}\n          >\n            <CallEndIcon className={classes.buttonIcon} />\n          </Button>\n        </div>\n      </div>\n\n      <TextField\n        className={classes.textField}\n        label=\"Type a message\"\n        variant=\"standard\"\n        onKeyDown={(e) => {\n          if (e.key === \"Enter\") {\n            // check if message is not empty\n            if (e.target.value.trim() === \"\") return;\n            if (e.target.value.trim().length > 50) {\n              toast.error(\"Message is too long\");\n              e.target.value = \"\";\n              return;\n            }\n            sendMessage(e.target.value);\n            e.target.value = \"\";\n          }\n        }}\n      />\n    </div>\n  );\n};\n\nexport default CallPage;\n"],"sourceRoot":""}